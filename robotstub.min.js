var Robot;
(function(){function h(a){function c(a){b.cannonAbsoluteAngle-=a;return 180>a?d("turnGunLeft",a):d("turnGunRight",360-a)}function e(a){b.cannonAbsoluteAngle-=a;b.angle-=a;return 180>a?d("turnLeft",a):d("turnRight",360-a)}function t(){return d("fire")}function d(a,d,c){var e=new g(this);b[a](d,c);b.notify(function(){e.resolve()});return e}function f(){var a=new g(this);setTimeout(function(){a.resolve()},0);return a}var b=a;this.id=a.id;this.parentId=a.parentId;this.behaviuor=[];this.setRobot=function(a){b=
a;this.id=b.id;this.parentId=b.parentId};this.getRobot=function(){return b};this.isMaster=a.parentId?!1:!0;this.behaviuor.push(u);this.isMaster?this.behaviuor.push(l):this.behaviuor.push(n);this.ahead=function(a){var c=(b.angle-90)*(Math.PI/180),e=a*Math.sin(c),c=a*Math.cos(c);b.position.x+=e;b.position.y+=c;0>b.position.x&&(b.position.x=0);0>b.position.y&&(b.position.y=0);return d("ahead",a)};this.back=function(a){var c=(b.angle-90)*(Math.PI/180),e=a*Math.sin(c),c=a*Math.cos(c);b.position.x-=e;b.position.y-=
c;b.position.x=Math.min(b.position.x,0);b.position.y=Math.min(b.position.y,0);return d("back",a)};this.move=function(a,b){return d("move",a,b)};this.rotateCannon=function(a){return d("rotateCannon",a)};this.turnGunLeft=c;this.turnGunRight=function(a){b.cannonAbsoluteAngle+=a;return 180>a?d("turnGunRight",a):d("turnGunLeft",360-a)};this.turn=function(a){b.cannonAbsoluteAngle+=a;b.angle+=a;return d("turn",a)};this.turnLeft=e;this.turnRight=function(a){b.cannonAbsoluteAngle+=a;b.angle+=a;return 180>
a?d("turnRight",a):d("turnLeft",360-a)};this.fire=t;this.disappear=function(){return d("disappear")};this.cannonAt=function(a){var d=null;a=180+v(b.position,a);a=b.cannonAbsoluteAngle-a;0>a&&(a=360+a);360<=a&&(a-=360);0!=a?(console.log("rt cnn "+a),d=c(a)):d=f();return d};this.fireAt=function(a){return this.cannonAt(a).then(t())};this.turnAt=function(a){a=180+v(b.position,a);a=b.angle+90-a;0>a&&(a=360+a);360<=a&&(a-=360);return 0!=a?(console.log("rt trn "+a),e(a)):f()};this.skip=f;this.stop=function(){b.stop();
return f()};this.stopPropagation=!1}function v(a,c){var e=Math.atan2(c.y-a.y,c.x-a.x);return Math.floor(e*(180/3.1459))}function y(a){for(var c,e=arguments,f=e.length,d;1<f&&a.length;)for(c=e[--f];-1!==(d=a.indexOf(c));)a.splice(d,1);return a}function g(a){if(a instanceof g)return a;this.callbacks=[];return this}var w=0,x={x:0,y:0},p={x:null,y:null},m={},f=null,k=0,q,u,r,s,n,l;n={Idle:function(){console.log("CLONE:"+this.id);this.addPlan(r);this.addPlan(s);delete n.Idle}};l={Idle:function(){console.log("MASTER:"+
this.id);this.addPlan(r);this.addPlan(q);console.log("Master.init");delete l.Idle},ScannedRobot:function(){console.log("Master: cloning");this.getRobot().clone();this.dropPlan(q);this.rotateCannon(0);this.addPlan(s);delete l.ScannedRobot}};u={WallCollision:function(){var a=90-this.getRobot().angle%90;this.turn(a)},RobotCollision:function(a){console.log("RobotCollision at"+a.bearing);this.isMaster?this.skip().then(this.turnAt(x)).then(this.ahead(100)):this.skip().then(this.turnAt(p)).then(this.ahead(100))}};
q={name:"patrolStrategy",Idle:function(){k++;null!==f?this.cannonAt(f).then(this.fire()):this.turnGunLeft(180);this.ahead(100)},HitByBullet:function(a){console.log("HitByBullet");this.isMaster?this.turnAt(x).then(this.disappear()).then(this.ahead(100)):this.turn(a.bearing).then(this.fire());this.turn(a.bearing).then(this.fire()).then(this.clone())}};r={Idle:function(){k++;20<k&&this.turnGunLeft(360)},ScannedRobot:function(a){a=a.scannedRobot;this.isEnemy(a)?(f=a.position,k=0,console.log("ENEMY: "+
a.id+" at "+f.x+":"+f.y)):console.log("FRIEND: "+a.id)}};s={Idle:function(){this.turnAt(f).then(this.cannonAt(f,!0)).then(this.fire()).then(this.turnGunLeft(10)).then(this.fire()).then(this.turnGunRight(20)).then(this.fire()).then(this.turnGunLeft(10)).then(this.ahead(10))},HitByBullet:function(a){this.stop().then(this.turn(a.bearing)).then(this.fire());10<Math.abs(a.bearing)&&(k=900719925474E4)}};h.prototype.dropPlan=function(a){y(this.behaviuor,a)};h.prototype.addPlan=function(a){this.behaviuor.push(a)};
h.prototype.processTurn=function(a,c){var e=this;e.stopPropagation=!1;e.behaviuor.forEach(function(f){e.stopPropagation||f[a]&&f[a].call(e,c)})};h.prototype.isEnemy=function(a){return this.isMaster?a.parentId!=this.id:a.id!=this.parentId};Robot=function(a){p.x=a.arenaWidth;p.y=a.arenaHeight};Robot.prototype.processTurn=function(a,c){m[c.robot.id].setRobot(c.robot);m[c.robot.id].processTurn(a,c)};Robot.prototype.onIdle=function(a){w++;900719925474E4<w||("undefined"==typeof m[a.robot.id]&&(console.log("PREVIOUSLY NOT KNOWN DROID "+
a.robot.id),m[a.robot.id]=new h(a.robot)),this.processTurn("Idle",a))};Robot.prototype.onWallCollision=function(a){a.robot.stop();this.processTurn("WallCollision",a)};Robot.prototype.onRobotCollision=function(a){this.processTurn("RobotCollision",a)};Robot.prototype.onScannedRobot=function(a){this.processTurn("ScannedRobot",a)};Robot.prototype.onHitByBullet=function(a){this.processTurn("HitByBullet",a)};g.prototype.then=function(a,c){this.callbacks.push({ok:a,error:c});return this};g.prototype.resolve=
function(){var a=this.callbacks.shift();a&&(a.ok&&"function"==typeof a.ok)&&a.ok.apply(this,arguments)};g.prototype.reject=function(){var a=this.callbacks.shift();a&&(a.error&&"function"==typeof a.error)&&a.error.apply(this,arguments)}})();
