var Robot;
(function(){function k(a){function c(a){b.cannonAbsoluteAngle-=a;return 180>a?d("turnGunLeft",a):d("turnGunRight",360-a)}function u(a){b.cannonAbsoluteAngle-=a;b.angle-=a;return 180>a?d("turnLeft",a):d("turnRight",360-a)}function g(){d("fire")}function d(a,d,e){var c=new h(this);b[a](d,e);b.notify(function(){c.resolve()});return c}function f(){var a=new h(this);setTimeout(function(){a.resolve()},0);return a}var b=a;this.id=a.id;this.parentId=a.parentId;this.behaviuor=[];this.setRobot=function(a){this.id=b.id;
this.parentId=b.parentId;b=a};this.getRobot=function(){return b};this.isMaster=a.parentId?!1:!0;this.behaviuor.push(v);this.isMaster?this.behaviuor.push(m):this.behaviuor.push(p);this.ahead=function(a){var c=(b.angle-90)*(Math.PI/180),e=a*Math.sin(c),c=a*Math.cos(c);b.position.x+=e;b.position.y+=c;0>b.position.x&&(b.position.x=0);0>b.position.y&&(b.position.y=0);return d("ahead",a)};this.back=function(a){var c=(b.angle-90)*(Math.PI/180),e=a*Math.sin(c),c=a*Math.cos(c);b.position.x-=e;b.position.y-=
c;b.position.x=Math.min(b.position.x,0);b.position.y=Math.min(b.position.y,0);return d("back",a)};this.move=function(a,b){return d("move",a,b)};this.rotateCannon=function(a){d("rotateCannon",a)};this.turnGunLeft=c;this.turnGunRight=function(a){b.cannonAbsoluteAngle+=a;return 180>a?d("turnGunRight",a):d("turnGunLeft",360-a)};this.turn=function(a){b.cannonAbsoluteAngle+=a;b.angle+=a;return d("turn",a)};this.turnLeft=u;this.turnRight=function(a){b.cannonAbsoluteAngle+=a;b.angle+=a;return 180>a?d("turnRight",
a):d("turnLeft",360-a)};this.fire=g;this.disappear=function(){d("disappear")};this.cannonAt=function(a,d){var e=null,e=180+w(b.position,a),e=b.cannonAbsoluteAngle-e;0>e&&(e=360+e);360<=e&&(e-=360);0!=e?(console.log("rt cnn "+e),e=c(e)):e=f();d||(e=0);return e};this.fireAt=function(a){this.cannonAt(a).then(g())};this.turnAt=function(a){a=180+w(b.position,a);a=b.angle+90-a;0>a&&(a=360+a);360<=a&&(a-=360);return 0!=a?(console.log("rt trn "+a),u(a)):f()};this.start=this.skip=f;this.stop=function(){b.stop();
return f()};this.stopPropagation=!1}function w(a,c){var f=Math.atan2(c.y-a.y,c.x-a.x);return Math.floor(f*(180/3.1459))}function z(a){for(var c,f=arguments,g=f.length,d;1<g&&a.length;)for(c=f[--g];-1!==(d=a.indexOf(c));)a.splice(d,1);return a}function h(a){if(a instanceof h)return a;this.callbacks=[];return this}var x=0,y={x:0,y:0},q={x:null,y:null},n={},f=null,l=0,r,v,s,t,p,m;p={Idle:function(){console.log("CLONE:"+this.id);this.addPlan(s);this.addPlan(t);delete p.Idle}};m={Idle:function(){console.log("MASTER:"+
this.id);this.addPlan(s);this.addPlan(r);console.log("Master.init");delete m.Idle},ScannedRobot:function(){console.log("Master: cloning");this.getRobot().clone();this.dropPlan(r);this.rotateCannon(0);this.addPlan(t);delete m.ScannedRobot}};v={WallCollision:function(){var a=90-this.getRobot().angle%90;this.turn(a)},RobotCollision:function(a){console.log("RobotCollision at"+a.bearing);this.isMaster?this.skip().then(this.turnAt(y)).then(this.ahead(100)):this.skip().then(this.turnAt(q)).then(this.ahead(100))}};
r={name:"patrolStrategy",Idle:function(){this.ahead(100);l++;null!==f?this.cannonAt(f).then(this.fire()):this.turnGunLeft(180)},HitByBullet:function(a){console.log("HitByBullet");this.isMaster?this.turnAt(y).then(this.disappear()).then(this.ahead(100)):this.turn(a.bearing).then(this.fire());this.turn(a.bearing).then(this.fire()).then(this.clone())}};s={Idle:function(){l++;20<l&&this.turnGunLeft(360)},ScannedRobot:function(a){a=a.scannedRobot;this.isEnemy(a)?(f=a.position,l=0,console.log("ENEMY: "+
a.id+" at "+f.x+":"+f.y)):console.log("FRIEND: "+a.id)}};t={Idle:function(){this.turnAt(f).then(this.cannonAt(f,!0)).then(this.fire()).then(this.turnGunLeft(10)).then(this.fire()).then(this.turnGunRight(20)).then(this.fire()).then(this.turnGunLeft(10)).then(this.ahead(10))},HitByBullet:function(a){this.stop().then(this.turn(a.bearing)).then(this.fire());10<Math.abs(a.bearing)&&(l=900719925474E4)}};k.prototype.dropPlan=function(a){z(this.behaviuor,a)};k.prototype.addPlan=function(a){this.behaviuor.push(a)};
k.prototype.processTurn=function(a,c){var f=this;f.stopPropagation=!1;f.behaviuor.forEach(function(g){f.stopPropagation||g[a]&&g[a].call(f,c)})};k.prototype.isEnemy=function(a){return this.isMaster?a.parentId!=this.id:a.id!=this.parentId};Robot=function(a){q.x=a.arenaWidth;q.y=a.arenaHeight};Robot.prototype.processTurn=function(a,c){n[c.robot.id].setRobot(c.robot);n[c.robot.id].processTurn(a,c)};Robot.prototype.onIdle=function(a){x++;900719925474E4<x||("undefined"==typeof n[a.robot.id]&&(n[a.robot.id]=
new k(a.robot)),this.processTurn("Idle",a))};Robot.prototype.onWallCollision=function(a){a.robot.stop();this.processTurn("WallCollision",a)};Robot.prototype.onRobotCollision=function(a){this.processTurn("RobotCollision",a)};Robot.prototype.onScannedRobot=function(a){this.processTurn("ScannedRobot",a)};Robot.prototype.onHitByBullet=function(a){this.processTurn("HitByBullet",a)};h.prototype.then=function(a,c){this.callbacks.push({ok:a,error:c});return this};h.prototype.resolve=function(){var a=this.callbacks.shift();
a&&a.ok&&a.ok.apply(this,arguments)};h.prototype.reject=function(){var a=this.callbacks.shift();a&&a.error&&a.error.apply(this,arguments)}})();
